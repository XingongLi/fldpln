
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Flood inundation modeling and mapping using the FLDPLN model">
      
      
        <meta name="author" content="xingongli">
      
      
        <link rel="canonical" href="https://xingongli.github.io/fldpln/tile/">
      
      
        <link rel="prev" href="../common/">
      
      
        <link rel="next" href="../mapping/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.33">
    
    
      
        <title>tile module - fldpln</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRegular:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Regular"}</style>
      
    
    
      <link rel="stylesheet" href="../css/timeago.css">
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tile-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="fldpln" class="md-header__button md-logo" aria-label="fldpln" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            fldpln
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              tile module
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/xingongli/fldpln" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="fldpln" class="md-nav__button md-logo" aria-label="fldpln" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    fldpln
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/xingongli/fldpln" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Usage
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FAQ
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/xingongli/fldpln/issues" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Report Issues
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fldpln/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fldpln module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../common/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    common module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    tile module
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    tile module
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile" class="md-nav__link">
    <span class="md-ellipsis">
      fldpln.tile
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.CalculateFspSegmentDownstreamDistance" class="md-nav__link">
    <span class="md-ellipsis">
      CalculateFspSegmentDownstreamDistance()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.CalculateLibraryExtent" class="md-nav__link">
    <span class="md-ellipsis">
      CalculateLibraryExtent()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.CalculateTileBoundary" class="md-nav__link">
    <span class="md-ellipsis">
      CalculateTileBoundary()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.DownloadSegmentLibrary" class="md-nav__link">
    <span class="md-ellipsis">
      DownloadSegmentLibrary()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.GenerateSegmentShapefilesFromFspSegmentInfoFiles" class="md-nav__link">
    <span class="md-ellipsis">
      GenerateSegmentShapefilesFromFspSegmentInfoFiles()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.GetStreamOrdersForFspsSegments" class="md-nav__link">
    <span class="md-ellipsis">
      GetStreamOrdersForFspsSegments()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.ReadMatFile" class="md-nav__link">
    <span class="md-ellipsis">
      ReadMatFile()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.TileLibrary" class="md-nav__link">
    <span class="md-ellipsis">
      TileLibrary()
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mapping/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mapping module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gauge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gauge module
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile" class="md-nav__link">
    <span class="md-ellipsis">
      fldpln.tile
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.CalculateFspSegmentDownstreamDistance" class="md-nav__link">
    <span class="md-ellipsis">
      CalculateFspSegmentDownstreamDistance()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.CalculateLibraryExtent" class="md-nav__link">
    <span class="md-ellipsis">
      CalculateLibraryExtent()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.CalculateTileBoundary" class="md-nav__link">
    <span class="md-ellipsis">
      CalculateTileBoundary()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.DownloadSegmentLibrary" class="md-nav__link">
    <span class="md-ellipsis">
      DownloadSegmentLibrary()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.GenerateSegmentShapefilesFromFspSegmentInfoFiles" class="md-nav__link">
    <span class="md-ellipsis">
      GenerateSegmentShapefilesFromFspSegmentInfoFiles()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.GetStreamOrdersForFspsSegments" class="md-nav__link">
    <span class="md-ellipsis">
      GetStreamOrdersForFspsSegments()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.ReadMatFile" class="md-nav__link">
    <span class="md-ellipsis">
      ReadMatFile()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fldpln.tile.TileLibrary" class="md-nav__link">
    <span class="md-ellipsis">
      TileLibrary()
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                



                  

  
  


<h1 id="tile-module">tile module<a class="headerlink" href="#tile-module" title="Permanent link">&para;</a></h1>


  <div class="doc doc-object doc-module">

<a id="fldpln.tile"></a>
    <div class="doc doc-contents first">

      <p>Module to re-organize FLDPLN segment-based library into tile-based library for fast mapping.</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h2 id="fldpln.tile.CalculateFspSegmentDownstreamDistance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">CalculateFspSegmentDownstreamDistance</span><span class="p">(</span><span class="n">libFolder</span><span class="p">,</span> <span class="n">libName</span><span class="p">)</span></code>


<a href="#fldpln.tile.CalculateFspSegmentDownstreamDistance" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Cleanup segments (some segments don't exist in FSPs) and save library FSP and segment information as two csv files (fsp_info.csv &amp; segment_info.csv). 
It reads in the SpatialReference.prj and save it in CellSizeSpatialReference.json. For stage interpolation, it also calculates FSP and segment 
downstream distance (i.e., distance to library outlet(s)) which involves:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>1. Calculate FSP&#39;s within-segment downstream distance
2. Calculate segment length which is more accurate than &quot;CellCount&quot; * cell size
3. Calculate segment&#39;s downstream distance (to watershed outlet) for speeding up 
4. Calculate FSP&#39;s downstream distance
</code></pre></div></td></tr></table></div>
<p>Note that FSPs and segments are based on raster cell centers. Segment and its downstream segment has a gap (1 cell or sqrt(2) cell).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>libFolder</code></td>
        <td><code>str</code></td>
        <td><p>folder containing the library.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>libName</code></td>
        <td><code>str</code></td>
        <td><p>library name.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>tuple</code></td>
      <td><p>FSP data frame. segment data frame.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>fldpln/tile.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">CalculateFspSegmentDownstreamDistance</span><span class="p">(</span><span class="n">libFolder</span><span class="p">,</span><span class="n">libName</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Cleanup segments (some segments don&#39;t exist in FSPs) and save library FSP and segment information as two csv files (fsp_info.csv &amp; segment_info.csv). </span>
<span class="sd">        It reads in the SpatialReference.prj and save it in CellSizeSpatialReference.json. For stage interpolation, it also calculates FSP and segment </span>
<span class="sd">        downstream distance (i.e., distance to library outlet(s)) which involves:</span>

<span class="sd">            1. Calculate FSP&#39;s within-segment downstream distance</span>
<span class="sd">            2. Calculate segment length which is more accurate than &quot;CellCount&quot; * cell size</span>
<span class="sd">            3. Calculate segment&#39;s downstream distance (to watershed outlet) for speeding up </span>
<span class="sd">            4. Calculate FSP&#39;s downstream distance</span>

<span class="sd">        Note that FSPs and segments are based on raster cell centers. Segment and its downstream segment has a gap (1 cell or sqrt(2) cell).</span>

<span class="sd">        Args:</span>
<span class="sd">            libFolder (str): folder containing the library.</span>
<span class="sd">            libName (str): library name.</span>

<span class="sd">        Return:</span>
<span class="sd">            tuple: FSP data frame. segment data frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># read in fsp (flood source pixel) and segment network info Excel files</span>
    <span class="c1">#</span>
    <span class="c1"># fspInfoColumnNames = [&#39;FspX&#39;,&#39;FspY&#39;,&#39;SegId&#39;,&#39;FilledElev&#39;], columns &#39;DsDist&#39; will be calculated by this function</span>
    <span class="c1"># segInfoColumnNames = [&#39;SegId&#39;,&#39;CellCount&#39;,&#39;DsSegId&#39;, &#39;StFac&#39;,&#39;EdFac&#39;], columns &#39;Length&#39;,&#39;DsDist&#39; will be added by this function</span>
    <span class="n">fspInfoFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">libFolder</span><span class="p">,</span> <span class="n">libName</span><span class="p">,</span> <span class="n">fspInfoFileName</span><span class="p">)</span>
    <span class="n">segInfoFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">libFolder</span><span class="p">,</span> <span class="n">libName</span><span class="p">,</span> <span class="n">segInfoFileName</span><span class="p">)</span>


    <span class="c1"># read in FSP ID and coordinates</span>
    <span class="c1"># need to set float_precision=&#39;round_trip&#39; to prevent rounding while reading the text file! float_precision=&#39;high&#39; DOESN&#39;T work.</span>
    <span class="c1"># For Verdigris 10-m library, FSP ID of 22246, its FspX of -1003.7918248322967 in fsp_info.csv was read into memory as -1003.7918248322968 without using float_precision=&#39;round_trip&#39;</span>
    <span class="n">fspDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fspInfoFile</span><span class="p">,</span><span class="n">float_precision</span><span class="o">=</span><span class="s1">&#39;round_trip&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">segDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">segInfoFile</span><span class="p">,</span><span class="n">float_precision</span><span class="o">=</span><span class="s1">&#39;round_trip&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Clean up the segment table.</span>
    <span class="c1"># 1. Remove the segment if it&#39;s not in the FSP table</span>
    <span class="c1"># 2. If the missing segment is the downstream segment of another segment, set it as 0. </span>
    <span class="c1"># Those missing segments are usually because of they are close to or in waterbodies. </span>
    <span class="c1"># By removing those segment, a library may have several separate watersheds/outlets!</span>
    <span class="c1">#</span>
    <span class="c1"># get the segment IDs</span>
    <span class="n">segIds</span> <span class="o">=</span> <span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">segIds</span><span class="p">:</span>
        <span class="n">fsps</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">sid</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fsps</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># segment not found in the FSP table. delete the row</span>
            <span class="n">segDf</span> <span class="o">=</span> <span class="n">segDf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">sid</span><span class="p">]</span>
            <span class="c1"># set downstream segment ID to 0</span>
            <span class="n">segDf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;DsSegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">sid</span><span class="p">,</span><span class="s1">&#39;DsSegId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#</span>
    <span class="c1"># Calculate FSP within-segment distance, segment length, and segment dowstream distance, and FSP downstream distance</span>
    <span class="c1">#</span>
    <span class="c1"># add field for FSP within-segment distance</span>
    <span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;DsDist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># add field for segment length</span>
    <span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Calculate FSP within-segment DOWNSTREAM distance and segment length</span>
    <span class="k">for</span> <span class="n">segIdx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">segDf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">segID</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span>
        <span class="c1"># print(segID)</span>

        <span class="c1"># select FSP on the segment</span>
        <span class="n">fsps</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">segID</span><span class="p">][[</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">]]</span>

        <span class="c1"># calculate fsp downstream within segment length</span>
        <span class="n">segDist</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fsps</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># this should not happen as we have already clean up the segment table!</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segment </span><span class="si">{</span><span class="n">segID</span><span class="si">}</span><span class="s2"> is missing in </span><span class="si">{</span><span class="n">fspInfoFileName</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">first</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">fsps</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="c1"># Note the idx in fsps is the index in fspDf!!!</span>
                <span class="c1"># calculate distance</span>
                <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">fspx1</span><span class="p">,</span> <span class="n">fspy1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;FspX&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;FspY&#39;</span><span class="p">]</span>
                    <span class="n">dist</span><span class="o">=</span><span class="mf">0.0</span>
                    <span class="n">first</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fspx2</span><span class="p">,</span> <span class="n">fspy2</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;FspX&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;FspY&#39;</span><span class="p">]</span>
                    <span class="n">dist</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">fspx1</span><span class="o">-</span><span class="n">fspx2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">fspy1</span><span class="o">-</span><span class="n">fspy2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">fspx1</span><span class="p">,</span> <span class="n">fspy1</span> <span class="o">=</span> <span class="n">fspx2</span><span class="p">,</span> <span class="n">fspy2</span>
                <span class="n">segDist</span> <span class="o">+=</span> <span class="n">dist</span>
                <span class="n">fspDf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="s1">&#39;DsDist&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">segDist</span>

        <span class="c1"># update segment distance in segDf</span>
        <span class="n">segDf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">segIdx</span><span class="p">,</span><span class="s1">&#39;Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segDist</span>

    <span class="c1"># show the DFs</span>
    <span class="c1"># print(fspDf[:1136])</span>
    <span class="c1"># print(segDf)</span>

    <span class="c1">#</span>
    <span class="c1"># Calculate segment downstream length</span>
    <span class="c1">#</span>
    <span class="c1"># only for the segments that exist in the FSP table</span>
    <span class="c1"># But this not necessary as segments don&#39;t exist in FSP table already removed</span>
    <span class="c1"># Also this line will remove the segment which has just one FSP!</span>
    <span class="c1"># segDf = segDf[segDf[&#39;Length&#39;]&gt;0]</span>

    <span class="c1"># add field for segment downstream distance for speeding up calculating FSP downstream distance</span>
    <span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;DsDist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">segIdx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">segDf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">segID</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span>
        <span class="n">dsSegID</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;DsSegId&#39;</span><span class="p">]</span>

        <span class="n">dsDist</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">while</span> <span class="n">dsSegID</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># get downstream segment length and ID</span>
            <span class="n">tempDf</span> <span class="o">=</span> <span class="n">segDf</span><span class="p">[</span><span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">dsSegID</span><span class="p">][[</span><span class="s1">&#39;Length&#39;</span><span class="p">,</span><span class="s1">&#39;DsSegId&#39;</span><span class="p">]]</span>
            <span class="n">length</span><span class="p">,</span> <span class="n">segID_ds</span> <span class="o">=</span> <span class="n">tempDf</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">tempDf</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dsDist</span> <span class="o">+=</span> <span class="n">length</span>

            <span class="c1"># There is a GAP between two segments as they are consisted of FSP cell centers</span>
            <span class="c1"># Calculate the GAP and add it to segment downstream dist</span>
            <span class="c1"># last fsp in upstream segment</span>
            <span class="n">lastFspXy</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">segID</span><span class="p">][[</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    
            <span class="n">fspx1</span><span class="p">,</span> <span class="n">fspy1</span> <span class="o">=</span> <span class="n">lastFspXy</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">lastFspXy</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># first FSP in downstream segment</span>
            <span class="n">firstFspXy</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">dsSegID</span><span class="p">][[</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fspx2</span><span class="p">,</span> <span class="n">fspy2</span> <span class="o">=</span> <span class="n">firstFspXy</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">firstFspXy</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dist</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">fspx1</span><span class="o">-</span><span class="n">fspx2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">fspy1</span><span class="o">-</span><span class="n">fspy2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">dsDist</span> <span class="o">+=</span> <span class="n">dist</span>

            <span class="c1"># move to ownstream segment</span>
            <span class="n">segID</span> <span class="o">=</span> <span class="n">dsSegID</span>
            <span class="n">dsSegID</span> <span class="o">=</span> <span class="n">segID_ds</span>

        <span class="n">segDf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">segIdx</span><span class="p">,</span><span class="s1">&#39;DsDist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsDist</span>
    <span class="c1"># print(segDf)</span>

    <span class="c1"># Calculate FSP downstream distance</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">fspDf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">segID</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span>
        <span class="n">inSegDist</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;DsDist&#39;</span><span class="p">]</span>

        <span class="c1"># get segment downstream distance</span>
        <span class="n">tempDf</span> <span class="o">=</span> <span class="n">segDf</span><span class="p">[</span><span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">segID</span><span class="p">][[</span><span class="s1">&#39;DsDist&#39;</span><span class="p">]]</span>
        <span class="n">segDsDist</span> <span class="o">=</span> <span class="n">tempDf</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># reset FSP downstream distance</span>
        <span class="n">fspDf</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="s1">&#39;DsDist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inSegDist</span> <span class="o">+</span> <span class="n">segDsDist</span>
    <span class="c1"># print(fspDf)</span>

    <span class="c1"># save the updated info files</span>
    <span class="n">fspDf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fspInfoFile</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span>
    <span class="n">segDf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">segInfoFile</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fspDf</span><span class="p">,</span> <span class="n">segDf</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="fldpln.tile.CalculateLibraryExtent" class="doc doc-heading">
<code class="highlight language-python"><span class="n">CalculateLibraryExtent</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span> <span class="n">cellSize</span><span class="p">)</span></code>


<a href="#fldpln.tile.CalculateLibraryExtent" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Calculate library external border extent. Also calculate segment extents (FPP cell center) and save them in a data frame.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>segLibFolder</code></td>
        <td><code>str</code></td>
        <td><p>folder containing the segment-based library.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>cellSize</code></td>
        <td><code>float</code></td>
        <td><p>cell size in meters.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>tuple</code></td>
      <td><p>external border extent (minX, maxX,minY, maxY), segment extent data frame of ['MinX','MaxX','MinY','MaxY','FileName'] (FPP cell center)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>fldpln/tile.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">CalculateLibraryExtent</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span> <span class="n">cellSize</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calculate library external border extent. Also calculate segment extents (FPP cell center) and save them in a data frame.</span>
<span class="sd">        Args:</span>
<span class="sd">            segLibFolder (str): folder containing the segment-based library.</span>
<span class="sd">            cellSize (float): cell size in meters.</span>
<span class="sd">        Return:</span>
<span class="sd">            tuple: external border extent (minX, maxX,minY, maxY), segment extent data frame of [&#39;MinX&#39;,&#39;MaxX&#39;,&#39;MinY&#39;,&#39;MaxY&#39;,&#39;FileName&#39;] (FPP cell center)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get all the segment mat files in the library/watershed</span>
    <span class="n">segMatFileFullNames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span> <span class="n">segMatFileMainName</span><span class="o">+</span><span class="s1">&#39;*.mat&#39;</span><span class="p">))</span>
    <span class="n">hcs</span> <span class="o">=</span> <span class="n">cellSize</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1"># initialize extent</span>
    <span class="n">minX</span><span class="p">,</span><span class="n">maxX</span><span class="p">,</span><span class="n">minY</span><span class="p">,</span><span class="n">maxY</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">relNum</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of FSP-FPP relation</span>
    <span class="n">segExts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MinX&#39;</span><span class="p">,</span><span class="s1">&#39;MaxX&#39;</span><span class="p">,</span><span class="s1">&#39;MinY&#39;</span><span class="p">,</span><span class="s1">&#39;MaxY&#39;</span><span class="p">,</span><span class="s1">&#39;FileName&#39;</span><span class="p">])</span> <span class="c1"># empty df storing each segment&#39;s FPP extent and corresponding mat file name</span>
    <span class="c1"># update the extent by all the segments</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculate library extent ...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">segMatFileFullNames</span><span class="p">:</span>
        <span class="c1"># read mat file</span>
        <span class="n">matVar</span> <span class="o">=</span> <span class="n">ReadMatFile</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">matRelVarName</span><span class="p">)</span>
        <span class="c1"># converting array to a dataframe</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">matVar</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">matRelColumnNames</span><span class="p">)</span>

        <span class="n">relNum</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># print(&#39;Segment:&#39;, segId, &#39;Number of FSP-FPP relations:&#39;, len(df))</span>

        <span class="c1"># Calculate segment external border extent</span>
        <span class="n">sminX</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floodplain_pixel_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">hcs</span>
        <span class="n">sminY</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floodplain_pixel_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">hcs</span>
        <span class="n">smaxX</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floodplain_pixel_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">hcs</span>
        <span class="n">smaxY</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floodplain_pixel_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">hcs</span>
        <span class="n">segExt</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">sminX</span><span class="p">,</span><span class="n">smaxX</span><span class="p">,</span><span class="n">sminY</span><span class="p">,</span><span class="n">smaxY</span><span class="p">,</span><span class="n">mf</span><span class="p">]],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MinX&#39;</span><span class="p">,</span><span class="s1">&#39;MaxX&#39;</span><span class="p">,</span><span class="s1">&#39;MinY&#39;</span><span class="p">,</span><span class="s1">&#39;MaxY&#39;</span><span class="p">,</span><span class="s1">&#39;FileName&#39;</span><span class="p">])</span>
        <span class="c1"># add the segment extent to the df</span>
        <span class="c1"># segExts = segExts.append(segExt)</span>
        <span class="n">segExts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">segExts</span><span class="p">,</span><span class="n">segExt</span><span class="p">])</span>

        <span class="c1">#update library extent</span>
        <span class="k">if</span> <span class="n">sminX</span> <span class="o">&lt;</span> <span class="n">minX</span><span class="p">:</span> <span class="n">minX</span> <span class="o">=</span> <span class="n">sminX</span>
        <span class="k">if</span> <span class="n">sminY</span> <span class="o">&lt;</span> <span class="n">minY</span><span class="p">:</span> <span class="n">minY</span> <span class="o">=</span> <span class="n">sminY</span>
        <span class="k">if</span> <span class="n">smaxX</span> <span class="o">&gt;</span> <span class="n">maxX</span><span class="p">:</span> <span class="n">maxX</span> <span class="o">=</span> <span class="n">smaxX</span>
        <span class="k">if</span> <span class="n">smaxY</span> <span class="o">&gt;</span> <span class="n">maxY</span><span class="p">:</span> <span class="n">maxY</span> <span class="o">=</span> <span class="n">smaxY</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Library external border extent (minX, maxX, minY, maxY) :&#39;</span><span class="p">,(</span><span class="n">minX</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span><span class="n">minY</span><span class="p">,</span> <span class="n">maxY</span><span class="p">))</span>
    <span class="c1"># print(&#39;Library segment FPP extents:\n&#39;, segExts)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number of FSP-FPP relations:&#39;</span><span class="p">,</span> <span class="n">relNum</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">minX</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span><span class="n">minY</span><span class="p">,</span> <span class="n">maxY</span><span class="p">),</span> <span class="n">segExts</span> 
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="fldpln.tile.CalculateTileBoundary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">CalculateTileBoundary</span><span class="p">(</span><span class="n">minX</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span> <span class="n">minY</span><span class="p">,</span> <span class="n">maxY</span><span class="p">,</span> <span class="n">tileSizeX</span><span class="p">,</span> <span class="n">tileSizeY</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#fldpln.tile.CalculateTileBoundary" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Calculate each tile's boundary as (minX, maxX,minY, maxY).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>minX</code></td>
        <td><code>float</code></td>
        <td><p>min x of the external border (not the cell center) coordinates of the area needs to be tiled.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>maxX</code></td>
        <td><code>float</code></td>
        <td><p>max x of the external border (not the cell center) coordinates of the area needs to be tiled.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>minY</code></td>
        <td><code>float</code></td>
        <td><p>min y of the external border (not the cell center) coordinates of the area needs to be tiled.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>maxY</code></td>
        <td><code>float</code></td>
        <td><p>max y of the external border (not the cell center) coordinates of the area needs to be tiled.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>tileSizeX</code></td>
        <td><code>float</code></td>
        <td><p>tile external border size (not the cell center size) in x axis.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>tileSizeY</code></td>
        <td><code>float</code></td>
        <td><p>tile external border size (not the cell center size) in y axis.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>padding</code></td>
        <td><code>bool</code></td>
        <td><p>whether the tiles have the same size and not reduced to the border of the tiled area. Default is True.</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>list</code></td>
      <td><p>list of tile boundaries of (minX, maxX,minY, maxY)</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>fldpln/tile.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">CalculateTileBoundary</span><span class="p">(</span><span class="n">minX</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span> <span class="n">minY</span><span class="p">,</span> <span class="n">maxY</span><span class="p">,</span> <span class="n">tileSizeX</span><span class="p">,</span> <span class="n">tileSizeY</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calculate each tile&#39;s boundary as (minX, maxX,minY, maxY).</span>
<span class="sd">        Args:</span>
<span class="sd">            minX (float): min x of the external border (not the cell center) coordinates of the area needs to be tiled.</span>
<span class="sd">            maxX (float): max x of the external border (not the cell center) coordinates of the area needs to be tiled.</span>
<span class="sd">            minY (float): min y of the external border (not the cell center) coordinates of the area needs to be tiled.</span>
<span class="sd">            maxY (float): max y of the external border (not the cell center) coordinates of the area needs to be tiled.</span>
<span class="sd">            tileSizeX (float): tile external border size (not the cell center size) in x axis.</span>
<span class="sd">            tileSizeY (float): tile external border size (not the cell center size) in y axis.</span>
<span class="sd">            padding (bool): whether the tiles have the same size and not reduced to the border of the tiled area. Default is True.</span>
<span class="sd">        Return:</span>
<span class="sd">            list: list of tile boundaries of (minX, maxX,minY, maxY)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># helper function to generate tile boundary in one dimension</span>
    <span class="k">def</span> <span class="nf">TileInOneDimension</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">tileSize</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># generate tile marker coordinates</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">tileSize</span><span class="p">)</span>
        <span class="c1"># handle the last coordinate as np.arange() is inclusive</span>
        <span class="k">if</span> <span class="n">padding</span><span class="p">:</span> <span class="c1">#all the tiles have the same length whether it&#39;s outside the border of the tiled area or not</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">bs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">tileSize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># the last tile stops at the border of the area</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>

        <span class="c1"># generate tile border coordinate pairs</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">bs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">tb</span>

    <span class="n">xb</span> <span class="o">=</span> <span class="n">TileInOneDimension</span><span class="p">(</span><span class="n">minX</span><span class="p">,</span><span class="n">maxX</span><span class="p">,</span><span class="n">tileSizeX</span><span class="p">,</span><span class="n">padding</span><span class="p">)</span>
    <span class="n">yb</span> <span class="o">=</span> <span class="n">TileInOneDimension</span><span class="p">(</span><span class="n">minY</span><span class="p">,</span><span class="n">maxY</span><span class="p">,</span><span class="n">tileSizeY</span><span class="p">,</span><span class="n">padding</span><span class="p">)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xb</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">yb</span><span class="p">]</span> <span class="c1"># in ((minX, maxX),(minY, maxY))</span>
    <span class="c1"># convert to (minX, maxX,minY, maxY)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="p">[(</span><span class="n">minX</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span><span class="n">minY</span><span class="p">,</span> <span class="n">maxY</span><span class="p">)</span> <span class="k">for</span> <span class="p">((</span><span class="n">minX</span><span class="p">,</span><span class="n">maxX</span><span class="p">),(</span><span class="n">minY</span><span class="p">,</span><span class="n">maxY</span><span class="p">))</span> <span class="ow">in</span> <span class="n">tb</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tb</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="fldpln.tile.DownloadSegmentLibrary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">DownloadSegmentLibrary</span><span class="p">(</span><span class="n">segUrl</span><span class="p">,</span> <span class="n">libName</span><span class="p">,</span> <span class="n">localLibFolder</span><span class="p">)</span></code>


<a href="#fldpln.tile.DownloadSegmentLibrary" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Download segment-based library from the web and unzip it. Not implemented yet! 
The zip file name may vary from library to library as the max DOF may be different for different libraries.
For example: SLIE_KS_AOI_spring_DTF_49ft_(15m).zip, SLIE_KS_AOI_ninnescah_DTF_33ft_(10m).zip.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>segUrl</code></td>
        <td><code>str</code></td>
        <td><p>URL of the segment-based library.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>libName</code></td>
        <td><code>str</code></td>
        <td><p>library name.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>localLibFolder</code></td>
        <td><code>str</code></td>
        <td><p>local folder to store the library.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>None</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>fldpln/tile.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">DownloadSegmentLibrary</span><span class="p">(</span><span class="n">segUrl</span><span class="p">,</span> <span class="n">libName</span><span class="p">,</span> <span class="n">localLibFolder</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Download segment-based library from the web and unzip it. Not implemented yet! </span>
<span class="sd">        The zip file name may vary from library to library as the max DOF may be different for different libraries.</span>
<span class="sd">        For example: SLIE_KS_AOI_spring_DTF_49ft_(15m).zip, SLIE_KS_AOI_ninnescah_DTF_33ft_(10m).zip.</span>

<span class="sd">        Args:</span>
<span class="sd">            segUrl (str): URL of the segment-based library.</span>
<span class="sd">            libName (str): library name.</span>
<span class="sd">            localLibFolder (str): local folder to store the library.</span>
<span class="sd">        Return:</span>
<span class="sd">            None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Should use import requests instead of urllib.request</span>

    <span class="c1"># # get the zipped segment library file name, 	</span>
    <span class="c1"># #</span>
    <span class="c1"># segUrl = segUrl+&#39;/&#39;+libName</span>
    <span class="c1"># # remove space in the URL</span>
    <span class="c1"># url = segUrl.replace(&quot; &quot;,&quot;%20&quot;)</span>
    <span class="c1"># # create a request</span>
    <span class="c1"># req = urllib.request.Request(url)</span>
    <span class="c1"># # open and read the HTML page</span>
    <span class="c1"># htmlPage = urllib.request.urlopen(req).read()</span>
    <span class="c1"># # turn the HTML page from byte into string</span>
    <span class="c1"># htmlPageStr = str(htmlPage)</span>

    <span class="c1"># # get segment library zip file from the HTML page</span>
    <span class="c1"># p1 = &#39;href=\&quot;SLIE_KS_AOI_&#39;+libName+&#39;_DTF_\d{,3}ft_\(\d{,3}m\)\.zip\&quot;&#39;</span>
    <span class="c1"># hrefStr = re.findall(p1,str(htmlPageStr))[0]</span>
    <span class="c1"># p2 = &#39;SLIE_KS_AOI_&#39;+libName+&#39;_DTF_\d{,3}ft_\(\d{,3}m\)\.zip&#39;</span>
    <span class="c1"># zipFile = re.findall(p2,hrefStr)[0]</span>

    <span class="c1"># # create local folder if not existing</span>
    <span class="c1"># os.makedirs(localLibFolder,exist_ok=True)</span>

    <span class="c1"># # If you need to redownload for whatever reason</span>
    <span class="c1"># if os.path.exists(os.path.join(localLibFolder, libName)):</span>
    <span class="c1">#     shutil.rmtree(os.path.join(localLibFolder, libName))</span>
    <span class="c1"># os.mkdir(os.path.join(localLibFolder, libName))</span>

    <span class="c1"># # Download base library</span>
    <span class="c1"># print(f&#39;Downloading library {libName} ...&#39;)</span>
    <span class="c1"># urllib.request.urlretrieve(segUrl+&#39;/&#39;+zipFile,os.path.join(localLibFolder, libName, zipFile))</span>

    <span class="c1"># # Download FSP info Excel file</span>
    <span class="c1"># print(&quot;Downloading FSP Excel file ...&quot;)</span>
    <span class="c1"># urllib.request.urlretrieve(segUrl+&#39;/SLIE_KS_AOI_&#39;+libName+&#39;_fsp_info.xlsx&#39;, </span>
    <span class="c1">#     os.path.join(localLibFolder, libName, &#39;SLIE_KS_AOI_&#39;+libName+&#39;_fsp_info.xlsx&#39;))</span>

    <span class="c1"># # Download segment info Excel file</span>
    <span class="c1"># print(&quot;Downloading segment Excel file ...&quot;) #	segment_network_info_spring.xlsx</span>
    <span class="c1"># urllib.request.urlretrieve(segUrl+&#39;/segment_network_info_&#39;+libName+&#39;.xlsx&#39;, </span>
    <span class="c1">#     os.path.join(localLibFolder, libName, &#39;segment_network_info_&#39;+libName+&#39;.xlsx&#39;))</span>

    <span class="c1"># # unzip library</span>
    <span class="c1"># print(&quot;Unzipping ...&quot;)</span>
    <span class="c1"># # both shutil and zipFile do NOT support &quot;Deflated64&quot; or &quot;compression type 9&quot;</span>
    <span class="c1"># with zipfile.ZipFile(os.path.join(localLibFolder, libName, zipFile),&#39;r&#39;) as zip_ref:</span>
    <span class="c1">#     zip_ref.extractall(os.path.join(localLibFolder, libName)) </span>
    <span class="c1"># # shutil.unpack_archive(os.path.join(localLibFolder, libName, zipFile),os.path.join(localLibFolder, libName),&#39;zip&#39;)</span>

    <span class="c1"># # clean up folder</span>
    <span class="c1"># os.remove(os.path.join(localLibFolder, libName, zipFile))</span>
    <span class="c1"># print(&quot;Done for &quot;+libName)</span>

    <span class="k">return</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="fldpln.tile.GenerateSegmentShapefilesFromFspSegmentInfoFiles" class="doc doc-heading">
<code class="highlight language-python"><span class="n">GenerateSegmentShapefilesFromFspSegmentInfoFiles</span><span class="p">(</span><span class="n">segInfoFile</span><span class="p">,</span> <span class="n">fspInfoFile</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">outShpFile</span><span class="p">)</span></code>


<a href="#fldpln.tile.GenerateSegmentShapefilesFromFspSegmentInfoFiles" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Generate segment shapefiles from FSP and segment info files.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>segInfoFile</code></td>
        <td><code>str</code></td>
        <td><p>segment info file.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fspInfoFile</code></td>
        <td><code>str</code></td>
        <td><p>FSP info file.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>crs</code></td>
        <td><code>str</code></td>
        <td><p>coordinate reference system.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>outShpFile</code></td>
        <td><code>str</code></td>
        <td><p>output shapefile.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>      

        <details class="quote">
          <summary>Source code in <code>fldpln/tile.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">GenerateSegmentShapefilesFromFspSegmentInfoFiles</span><span class="p">(</span><span class="n">segInfoFile</span><span class="p">,</span> <span class="n">fspInfoFile</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">outShpFile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Generate segment shapefiles from FSP and segment info files.</span>

<span class="sd">        Args:</span>
<span class="sd">            segInfoFile (str): segment info file.</span>
<span class="sd">            fspInfoFile (str): FSP info file.</span>
<span class="sd">            crs (str): coordinate reference system.</span>
<span class="sd">            outShpFile (str): output shapefile.</span>

<span class="sd">        Return: </span>
<span class="sd">            None</span>
<span class="sd">     &quot;&quot;&quot;</span>

    <span class="c1"># read in FSP ID and coordinates</span>
    <span class="c1"># need to set float_precision=&#39;round_trip&#39; to prevent rounding while reading the text file! float_precision=&#39;high&#39; DOESN&#39;T work.</span>
    <span class="c1"># For Verdigris 10-m library, FSP ID of 22246, its FspX of -1003.7918248322967 in fsp_info.csv was read into memory as -1003.7918248322968 without using float_precision=&#39;round_trip&#39;</span>
    <span class="c1"># read column names</span>
    <span class="n">segColNames</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">segInfoFile</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># read in all the segments</span>
    <span class="n">segDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">segInfoFile</span><span class="p">,</span><span class="n">float_precision</span><span class="o">=</span><span class="s1">&#39;round_trip&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># read in FSP&#39;s SegId and its coordinates</span>
    <span class="n">fspDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fspInfoFile</span><span class="p">,</span><span class="n">float_precision</span><span class="o">=</span><span class="s1">&#39;round_trip&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;SegId&#39;</span><span class="p">,</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">]]</span>

    <span class="c1"># Create segment geometry list using FSP coordinates on a segment</span>
    <span class="n">segGeometry</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">segDf</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span> <span class="c1"># itertuples() is the fastest way of iterating a df</span>
        <span class="n">segID</span><span class="p">,</span><span class="n">dsSegID</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;SegId&#39;</span><span class="p">),</span><span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="s1">&#39;DsSegId&#39;</span><span class="p">))</span>

        <span class="c1"># select FSP on the segment</span>
        <span class="n">fsps</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">segID</span><span class="p">][[</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">]]</span>

        <span class="c1"># There is a GAP between two segments as they are consisted of FSP cell centers</span>
        <span class="c1"># Upstream sgements are EXTENDED to the first FSP of the downstream segment!</span>
        <span class="k">if</span> <span class="n">dsSegID</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># first FSP in downstream segment</span>
            <span class="n">firstFspXy</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">dsSegID</span><span class="p">][[</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># append to the fsps</span>
            <span class="c1"># fsps = fsps.append(firstFspXy)</span>
            <span class="n">fsps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fsps</span><span class="p">,</span><span class="n">firstFspXy</span><span class="p">])</span>
        <span class="c1"># print(fsps)</span>

        <span class="c1"># turn the FSPs into a LineString</span>
        <span class="c1"># create Points, a GeometryArray, from fsps</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="n">fsps</span><span class="p">[</span><span class="s1">&#39;FspX&#39;</span><span class="p">],</span><span class="n">fsps</span><span class="p">[</span><span class="s1">&#39;FspY&#39;</span><span class="p">])</span>
        <span class="n">segLineStr</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="c1"># print(segLineStr)</span>

        <span class="c1"># Insert the line into the geometry list</span>
        <span class="n">segGeometry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segLineStr</span><span class="p">)</span>

    <span class="c1"># create a geodataframe for writing shapefile</span>
    <span class="n">libSegs</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">segDf</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">segGeometry</span><span class="p">)</span>

    <span class="c1"># Write the data into that Shapefile</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">infer_schema</span><span class="p">(</span><span class="n">libSegs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">segColNames</span><span class="p">:</span>
        <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">segColSchema</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="n">libSegs</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">outShpFile</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span> <span class="s2">&quot;ESRI Shapefile&quot;</span><span class="p">,</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span> <span class="c1"># existing shapefile will be replaced automatically!!!</span>

    <span class="k">return</span> <span class="c1">#libSegs</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="fldpln.tile.GetStreamOrdersForFspsSegments" class="doc doc-heading">
<code class="highlight language-python"><span class="n">GetStreamOrdersForFspsSegments</span><span class="p">(</span><span class="n">libFolder</span><span class="p">,</span> <span class="n">strOrdShpFile</span><span class="p">,</span> <span class="n">shpSegIdName</span><span class="p">,</span> <span class="n">shpStrOrdColName</span><span class="p">)</span></code>


<a href="#fldpln.tile.GetStreamOrdersForFspsSegments" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Get stream order for FSPs and segments from segment stream order shapefile and save them in fsp_info.csv and segment_info.csv files. 
It also creates file stream_order_info.csv which stores the network info at the level of stream orders for FSP DOF interpolation.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>libFolder</code></td>
        <td><code>str</code></td>
        <td><p>library folder.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>strOrdShpFile</code></td>
        <td><code>str</code></td>
        <td><p>stream order shapefile.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>shpSegIdName</code></td>
        <td><code>str</code></td>
        <td><p>segment ID column name in the shapefile.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>shpStrOrdColName</code></td>
        <td><code>str</code></td>
        <td><p>stream order column name in the shapefile.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>tuple</code></td>
      <td><p>FSP data frame, segment data frame, stream order network data frame.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>fldpln/tile.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">GetStreamOrdersForFspsSegments</span><span class="p">(</span><span class="n">libFolder</span><span class="p">,</span><span class="n">strOrdShpFile</span><span class="p">,</span><span class="n">shpSegIdName</span><span class="p">,</span><span class="n">shpStrOrdColName</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Get stream order for FSPs and segments from segment stream order shapefile and save them in fsp_info.csv and segment_info.csv files. </span>
<span class="sd">        It also creates file stream_order_info.csv which stores the network info at the level of stream orders for FSP DOF interpolation.</span>

<span class="sd">        Args:</span>
<span class="sd">            libFolder (str): library folder.</span>
<span class="sd">            strOrdShpFile (str): stream order shapefile.</span>
<span class="sd">            shpSegIdName (str): segment ID column name in the shapefile.</span>
<span class="sd">            shpStrOrdColName (str): stream order column name in the shapefile.</span>

<span class="sd">        Return:</span>
<span class="sd">            tuple: FSP data frame, segment data frame, stream order network data frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get stream order from the shapefile</span>
    <span class="n">shpDf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">strOrdShpFile</span><span class="p">)</span>

    <span class="c1"># select columns</span>
    <span class="n">streamOrderColumns</span> <span class="o">=</span> <span class="p">[</span><span class="n">shpSegIdName</span><span class="p">,</span><span class="n">shpStrOrdColName</span><span class="p">]</span>
    <span class="n">segOrdDf</span> <span class="o">=</span> <span class="n">shpDf</span><span class="p">[</span><span class="n">streamOrderColumns</span><span class="p">]</span>
    <span class="c1"># rename shp order column to &#39;StrOrd&#39;</span>
    <span class="n">segOrdDf</span> <span class="o">=</span> <span class="n">segOrdDf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">shpSegIdName</span><span class="p">:</span> <span class="s1">&#39;SegId&#39;</span><span class="p">,</span> <span class="n">shpStrOrdColName</span><span class="p">:</span> <span class="n">strOrdColName</span><span class="p">})</span>
    <span class="c1"># print(segOrdDf)</span>

    <span class="c1"># read fsp and segment info csv files</span>
    <span class="n">fspCsvFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">libFolder</span><span class="p">,</span><span class="n">fspInfoFileName</span><span class="p">)</span>
    <span class="n">segCsvFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">libFolder</span><span class="p">,</span><span class="n">segInfoFileName</span><span class="p">)</span>
    <span class="c1"># need to set float_precision=&#39;round_trip&#39; to prevent rounding while reading the text file! float_precision=&#39;high&#39; DOESN&#39;T work.</span>
    <span class="c1"># For Verdigris 10-m library, FSP ID of 22246, its FspX of -1003.7918248322967 in fsp_info.csv was read into memory as -1003.7918248322968 without using float_precision=&#39;round_trip&#39;</span>
    <span class="n">fspDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fspCsvFile</span><span class="p">,</span><span class="n">float_precision</span><span class="o">=</span><span class="s1">&#39;round_trip&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">segDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">segCsvFile</span><span class="p">,</span><span class="n">float_precision</span><span class="o">=</span><span class="s1">&#39;round_trip&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># remove existing &quot;StrOrd&quot; column</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;StrOrd&#39;</span> <span class="ow">in</span> <span class="n">fspDf</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">fspDf</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;StrOrd&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;StrOrd&#39;</span> <span class="ow">in</span> <span class="n">segDf</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">segDf</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;StrOrd&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get segment stream order by merging DFs based on segment ID</span>
    <span class="n">segDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">segDf</span><span class="p">,</span> <span class="n">segOrdDf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;SegId&#39;</span><span class="p">)</span>
    <span class="c1"># print(segDf)</span>

    <span class="c1"># Get FSP&#39;s stream order by merging</span>
    <span class="n">fspDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fspDf</span><span class="p">,</span> <span class="n">segOrdDf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;SegId&#39;</span><span class="p">)</span>
    <span class="c1"># print(segDf)</span>

    <span class="c1"># save the DFs in CSVs</span>
    <span class="n">fspDf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fspCsvFile</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span>
    <span class="n">segDf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">segCsvFile</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Create another table storing stream order network information with the columns:</span>
    <span class="c1"># [‘StrOrd’, ‘DsStrOrd’, ‘JunctionFspX’, ‘JunctionFspY’] for use in interpolting FSP DOF</span>
    <span class="c1">#</span>
    <span class="n">strOrdDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">strOrdNetColumnNames</span><span class="p">)</span>
    <span class="n">strOrds</span> <span class="o">=</span> <span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;StrOrd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">strOrds</span><span class="p">:</span>
        <span class="c1"># find the most downstream segment in the stream order</span>
        <span class="n">mostDsSeg</span> <span class="o">=</span> <span class="n">segDf</span><span class="p">[</span><span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;StrOrd&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">so</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;DsDist&#39;</span><span class="p">)[[</span><span class="s1">&#39;DsSegId&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># print(mostDsSeg)</span>
        <span class="c1"># get its downstream segment ID</span>
        <span class="n">dsSegId</span> <span class="o">=</span> <span class="n">mostDsSeg</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dsSegId</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># get downstream stream order</span>
            <span class="n">dsOrd</span> <span class="o">=</span> <span class="n">segDf</span><span class="p">[</span><span class="n">segDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">dsSegId</span><span class="p">][</span><span class="s1">&#39;StrOrd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># get the first FSP in the downstream segment</span>
            <span class="n">firstFspXy</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;SegId&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">dsSegId</span><span class="p">][[</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fspx</span><span class="p">,</span> <span class="n">fspy</span> <span class="o">=</span> <span class="n">firstFspXy</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">firstFspXy</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no downstream segment</span>
            <span class="n">dsOrd</span><span class="p">,</span><span class="n">fspx</span><span class="p">,</span><span class="n">fspy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

        <span class="c1"># add the connectivity information to the table</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">so</span><span class="p">,</span><span class="n">dsOrd</span><span class="p">,</span><span class="n">fspx</span><span class="p">,</span><span class="n">fspy</span><span class="p">]],</span><span class="n">columns</span><span class="o">=</span><span class="n">strOrdNetColumnNames</span><span class="p">)</span>    
        <span class="c1"># append to the index table</span>
        <span class="c1"># strOrdDf = strOrdDf.append(temp,ignore_index=True)</span>
        <span class="n">strOrdDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">strOrdDf</span><span class="p">,</span> <span class="n">temp</span><span class="p">],</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># save the table as a CSV file</span>
    <span class="n">strOrdCsvFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">libFolder</span><span class="p">,</span> <span class="n">strOrdNetFileName</span><span class="p">)</span>
    <span class="n">strOrdDf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">strOrdCsvFile</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fspDf</span><span class="p">,</span> <span class="n">segDf</span><span class="p">,</span> <span class="n">strOrdDf</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="fldpln.tile.ReadMatFile" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ReadMatFile</span><span class="p">(</span><span class="n">matFile</span><span class="p">,</span> <span class="n">varName</span><span class="p">)</span></code>


<a href="#fldpln.tile.ReadMatFile" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Read matlab files with different versions. scipy.io DOES NOT support MATLAB files version 7.3 yet! Some of the libraries are in 7.3 while the others are not.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>matFile</code></td>
        <td><code>str</code></td>
        <td><p>matlab file name.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>varName</code></td>
        <td><code>str</code></td>
        <td><p>variable name in the matlab file.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>data frame</code></td>
      <td><p>variable matrix in the matlab file.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>fldpln/tile.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">ReadMatFile</span><span class="p">(</span><span class="n">matFile</span><span class="p">,</span> <span class="n">varName</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Read matlab files with different versions. scipy.io DOES NOT support MATLAB files version 7.3 yet! Some of the libraries are in 7.3 while the others are not.</span>
<span class="sd">        Args:</span>
<span class="sd">            matFile (str): matlab file name.</span>
<span class="sd">            varName (str): variable name in the matlab file.</span>
<span class="sd">        Return:</span>
<span class="sd">            data frame: variable matrix in the matlab file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span> 
        <span class="c1"># load the segment FSP-FPP-DTF table in mat file as &lt; 7.3. </span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">matFile</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="n">varName</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">matFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">vars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="c1"># get the variable and transpose it for dataframe!</span>
        <span class="n">var</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="n">varName</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not read the mat file at all...&#39;</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">var</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 id="fldpln.tile.TileLibrary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">TileLibrary</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span> <span class="n">cellSize</span><span class="p">,</span> <span class="n">tiledLibFolder</span><span class="p">,</span> <span class="n">tileSize</span><span class="p">,</span> <span class="n">fileFormat</span><span class="p">)</span></code>


<a href="#fldpln.tile.TileLibrary" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>Tile a library. Turn segment-based FSP-FPP relations to tile-based. Note that 'snappy' format needs to install the 'fastparquet' python package</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>segLibFolder</code></td>
        <td><code>str</code></td>
        <td><p>folder containing the segment-based library.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>cellSize</code></td>
        <td><code>float</code></td>
        <td><p>cell size in meters.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>tiledLibFolder</code></td>
        <td><code>str</code></td>
        <td><p>folder for the tiled library.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>tileSize</code></td>
        <td><code>int</code></td>
        <td><p>number of cells in a tile.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fileFormat</code></td>
        <td><code>str</code></td>
        <td><p>'snappy' or 'mat'.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>metadata of the tiled library</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>fldpln/tile.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">TileLibrary</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span> <span class="n">cellSize</span><span class="p">,</span> <span class="n">tiledLibFolder</span><span class="p">,</span> <span class="n">tileSize</span><span class="p">,</span> <span class="n">fileFormat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Tile a library. Turn segment-based FSP-FPP relations to tile-based. Note that &#39;snappy&#39; format needs to install the &#39;fastparquet&#39; python package</span>

<span class="sd">        Args:</span>
<span class="sd">            segLibFolder (str): folder containing the segment-based library.</span>
<span class="sd">            cellSize (float): cell size in meters.</span>
<span class="sd">            tiledLibFolder (str): folder for the tiled library.</span>
<span class="sd">            tileSize (int): number of cells in a tile.</span>
<span class="sd">            fileFormat (str): &#39;snappy&#39; or &#39;mat&#39;.</span>

<span class="sd">        Return:</span>
<span class="sd">            dict: metadata of the tiled library</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#     Parameters:</span>
    <span class="c1">#         segLibFolder: folder containing the segment-based library</span>
    <span class="c1">#         cellSize: cell size in meters</span>
    <span class="c1">#         tiledLibFolder: folder for the tiled library</span>
    <span class="c1">#         tileSize: number of cells in a tile</span>
    <span class="c1">#         fileFormat: &#39;snappy&#39; or &#39;mat&#39;. &#39;snappy&#39; format needs to install the &#39;fastparquet&#39; python package</span>
    <span class="c1">#     Return: metadata of the tiled library</span>
    <span class="c1"># &quot;&quot;&quot;</span>
    <span class="c1"># This function uses the fsp_info.csv file (under tiledLibFolder) to get FSP IDs</span>
    <span class="c1"># fileFormat: &#39;snappy&#39; or &#39;mat&#39;. &#39;snappy&#39; format needs to install the &#39;fastparquet&#39; python package</span>
    <span class="c1"># tileSize changed to the number of cells on May 27, 2024 to avoid partial cells within a tile and also works for GCS system</span>

    <span class="c1"># create the tiledLibFolder folder for all tiled libraries if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tiledLibFolder</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># </span>
    <span class="c1"># copy FSP and segment info CSV files to tiled library folder</span>
    <span class="c1"># </span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span> <span class="n">fspInfoFileName</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiledLibFolder</span><span class="p">,</span> <span class="n">fspInfoFileName</span><span class="p">))</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span> <span class="n">segInfoFileName</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiledLibFolder</span><span class="p">,</span> <span class="n">segInfoFileName</span><span class="p">))</span>

    <span class="c1">#</span>
    <span class="c1"># save tile size, cell size and spatial reference in a metadata file </span>
    <span class="c1">#</span>
    <span class="c1"># read in spatial reference for the library</span>
    <span class="n">srFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span><span class="n">prjFileName</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">srFile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">srf</span><span class="p">:</span>
        <span class="n">srText</span> <span class="o">=</span> <span class="n">srf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">metaData</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TileSize&#39;</span><span class="p">:</span> <span class="n">tileSize</span><span class="p">,</span> <span class="s1">&#39;CellSize&#39;</span><span class="p">:</span> <span class="n">cellSize</span><span class="p">,</span> <span class="s1">&#39;SpatialReference&#39;</span><span class="p">:</span> <span class="n">srText</span><span class="p">}</span>
    <span class="c1"># save metedata</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiledLibFolder</span><span class="p">,</span> <span class="n">metaDataFileName</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jf</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metaData</span><span class="p">,</span><span class="n">jf</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># calculate library and segment extents</span>
    <span class="n">libExt</span><span class="p">,</span> <span class="n">segExts</span> <span class="o">=</span> <span class="n">CalculateLibraryExtent</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span><span class="n">cellSize</span><span class="p">)</span>
    <span class="n">minX</span><span class="p">,</span><span class="n">maxX</span><span class="p">,</span><span class="n">minY</span><span class="p">,</span><span class="n">maxY</span> <span class="o">=</span> <span class="n">libExt</span>

    <span class="c1"># Calculate tile boundaries</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">CalculateTileBoundary</span><span class="p">(</span><span class="n">minX</span><span class="p">,</span><span class="n">maxX</span><span class="p">,</span><span class="n">minY</span><span class="p">,</span><span class="n">maxY</span><span class="p">,</span><span class="n">tileSize</span><span class="o">*</span><span class="n">cellSize</span><span class="p">,</span><span class="n">tileSize</span><span class="o">*</span><span class="n">cellSize</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of (possible) tiles:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tile extents:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Create tiles</span>
    <span class="c1">#</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Build tiles (tiling FSP-FPP relations) ...&#39;</span><span class="p">)</span>
    <span class="n">hcs</span> <span class="o">=</span> <span class="n">cellSize</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1"># read in FSP ID and coordinates</span>
    <span class="c1"># need to set float_precision=&#39;round_trip&#39; to prevent rounding while reading the text file! float_precision=&#39;high&#39; DOESN&#39;T work.</span>
    <span class="c1"># For Verdigris 10-m library, FSP ID of 22246, its FspX of -1003.7918248322967 in fsp_info.csv was read into memory as -1003.7918248322968 without using float_precision=&#39;round_trip&#39;</span>
    <span class="n">fspIds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segLibFolder</span><span class="p">,</span><span class="n">fspInfoFileName</span><span class="p">),</span><span class="n">float_precision</span><span class="o">=</span><span class="s1">&#39;round_trip&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;FspId&#39;</span><span class="p">,</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">]]</span>

    <span class="c1"># initialize the index DFs and tile ID</span>
    <span class="n">fspIdxDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">fspIdxColumnNames</span><span class="p">)</span>
    <span class="n">tileIdxDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">tileIdxColumnNames</span><span class="p">)</span>
    <span class="n">tileId</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tb</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing tile: &#39;</span><span class="p">,</span> <span class="n">tileId</span><span class="p">)</span>

        <span class="c1"># tile boundary, not the cell center boundary!</span>
        <span class="n">tminX</span><span class="p">,</span> <span class="n">tmaxX</span><span class="p">,</span><span class="n">tminY</span><span class="p">,</span> <span class="n">tmaxY</span> <span class="o">=</span> <span class="n">t</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tile extent (minX, maxX, minY, maxY) :&#39;</span><span class="p">,(</span><span class="n">tminX</span><span class="p">,</span> <span class="n">tmaxX</span><span class="p">,</span><span class="n">tminY</span><span class="p">,</span> <span class="n">tmaxY</span><span class="p">))</span>

        <span class="c1"># find the segments that intersect the tile rectangle</span>
        <span class="n">segs</span> <span class="o">=</span> <span class="n">segExts</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">segExts</span><span class="p">[</span><span class="s1">&#39;MinX&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">tmaxX</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">segExts</span><span class="p">[</span><span class="s1">&#39;MaxX&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">tminX</span><span class="p">))]</span> <span class="c1"># rectangles are NOT on left or right of each other</span>
        <span class="n">segs</span> <span class="o">=</span> <span class="n">segs</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">segs</span><span class="p">[</span><span class="s1">&#39;MinY&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">tmaxY</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">segs</span><span class="p">[</span><span class="s1">&#39;MaxY&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">tminY</span><span class="p">))]</span> <span class="c1"># rectangles are NOT on top or bottom of each other</span>
        <span class="n">segs</span> <span class="o">=</span> <span class="n">segs</span><span class="p">[</span><span class="s1">&#39;FileName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of segments interseting with the tile: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">segs</span><span class="p">))</span>

        <span class="c1"># find the FPP-FSP relations in the tile from all the intersecting segments</span>
        <span class="c1"># Initialize the df</span>
        <span class="n">tdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">segs</span><span class="p">:</span> <span class="c1">#segMatFileFullNames:</span>
            <span class="c1"># read mat file</span>
            <span class="n">matVar</span> <span class="o">=</span> <span class="n">ReadMatFile</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">matRelVarName</span><span class="p">)</span>
            <span class="c1"># converting array to a dataframe</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">matVar</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">matRelColumnNames</span><span class="p">)</span>

            <span class="c1"># rename columns to better names</span>
            <span class="n">betterColumnNames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FspX&quot;</span><span class="p">,</span> <span class="s2">&quot;FspY&quot;</span><span class="p">,</span> <span class="s2">&quot;FppX&quot;</span><span class="p">,</span> <span class="s2">&quot;FppY&quot;</span><span class="p">,</span> <span class="s2">&quot;Dtf&quot;</span><span class="p">,</span> <span class="s2">&quot;FilledDepth&quot;</span><span class="p">]</span>
            <span class="n">d</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">matRelColumnNames</span><span class="p">,</span><span class="n">betterColumnNames</span><span class="p">))</span>
            <span class="n">sdf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">d</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># inplace changing column name</span>

            <span class="c1"># Code used to find out which segment file (e.g., SLIE_segment40.mat) in library &#39;midkan&quot; has problem </span>
            <span class="c1"># where column “DTF + fill depth” is LESS than the &quot;DTF&quot; column</span>
            <span class="c1"># t  =  sdf[&#39;FilledDepth&#39;] - sdf[&#39;Dtf&#39;]</span>
            <span class="c1"># t  =  t &lt; -0.1</span>
            <span class="c1"># if t.any():</span>
            <span class="c1">#     print(&#39;Segment: &#39;, mf)</span>
            <span class="c1">#     print(f&#39;Found negative depression in {mf}!&#39;)</span>

            <span class="c1"># select the FPPs within the tile</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;FppX&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">tminX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;FppX&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">tmaxX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;FppY&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">tminY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s1">&#39;FppY&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">tmaxY</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># tell pandas we want a copy to avoid &quot;SettingWithCopyWarning&quot; in line 86 when there is only one segment mat file read</span>
            <span class="c1"># print(&#39;Segment:&#39;, segId, &#39;Number of FSP-FPP relations:&#39;, len(sdf))</span>
            <span class="k">if</span> <span class="n">tdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">tdf</span> <span class="o">=</span> <span class="n">sdf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># tdf = tdf.append(sdf)</span>
                <span class="n">tdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tdf</span><span class="p">,</span> <span class="n">sdf</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number of FSP-FPP relations in the tile:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tdf</span><span class="p">))</span>

        <span class="c1"># save the FSP-FPP relations and update the index dfs</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">empty</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tdf</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span> <span class="c1"># there are some FPPs in the tile</span>
            <span class="c1"># #calculate FilledDepth</span>
            <span class="c1"># tdf[&#39;FilledDepth&#39;] = tdf[&#39;FilledDepth&#39;]-tdf[&#39;Dtf&#39;] # This is NOT necessary as FLDPLN model output changed to save &quot;sink fill depth&quot; in v8. Modified by Xingong on 7/1/24</span>

            <span class="c1"># Calculate FSP center extent for the tile</span>
            <span class="n">fspMinX</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FspX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">fspMaxX</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FspX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">fspMinY</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FspY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">fspMaxY</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FspY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># Calculate FPP center extent within the tile</span>
            <span class="n">fppMinX</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FppX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">fppMaxX</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FppX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">fppMinY</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FppY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">fppMaxY</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FppY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># turn FPP coordinates into row and column within the tile</span>
            <span class="c1"># Note that the row and column start at (fppMinX, fppMaxY)!</span>
            <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FppX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">tdf</span><span class="o">.</span><span class="n">FppX</span><span class="o">-</span><span class="n">fppMinX</span><span class="p">)</span><span class="o">/</span><span class="n">cellSize</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
            <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;FppY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fppMaxY</span><span class="o">-</span><span class="n">tdf</span><span class="o">.</span><span class="n">FppY</span><span class="p">)</span><span class="o">/</span><span class="n">cellSize</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
            <span class="c1"># tdf[&#39;FppIdx&#39;] = tdf.FppX * tRows + tdf.FppY</span>

            <span class="c1"># rename [&#39;FppX&#39;,&#39;FppY&#39;] to [&#39;Col&#39;,&#39;Row&#39;]</span>
            <span class="n">tdf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;FppX&#39;</span><span class="p">:</span><span class="s1">&#39;FppCol&#39;</span><span class="p">,</span><span class="s1">&#39;FppY&#39;</span><span class="p">:</span><span class="s1">&#39;FppRow&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># merge relations with FSP IDs</span>
            <span class="n">tdf</span> <span class="o">=</span> <span class="n">tdf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fspIds</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">])</span>

            <span class="c1"># # check FSP IDs</span>
            <span class="c1"># if tdf.isnull().values.any():</span>
            <span class="c1">#     print(&#39;There are NAN in the dataframe!&#39;)</span>

            <span class="c1"># remove FspX &amp; FspY</span>
            <span class="n">tdf</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;FspX&#39;</span><span class="p">,</span><span class="s1">&#39;FspY&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># reorder columns</span>
            <span class="n">tdf</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="n">relColumnNames</span><span class="p">]</span>

            <span class="c1"># set datatypes for the columns</span>
            <span class="n">tdf</span><span class="o">=</span><span class="n">tdf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FspId&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="s2">&quot;FppCol&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="s2">&quot;FppRow&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="s2">&quot;Dtf&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s2">&quot;FilledDepth&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">},</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># convert float64 to float32 before saving and create index on FspX and FspY for speed up merge during mapping</span>
            <span class="c1"># tdf.astype(np.float32,copy=False).set_index(keys=[&#39;FspX&#39;,&#39;FspY&#39;],inplace=True)</span>

            <span class="c1"># save the relations in the tile in a file</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving FSP-FPP relations in a file...&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fileFormat</span> <span class="o">==</span> <span class="s1">&#39;snappy&#39;</span><span class="p">:</span>
                <span class="c1"># filePathName = os.path.join(segLibFolder, tileFileMainName+&#39;_&#39;+str(tileId)+&#39;.gzip&#39;) # for gzip format</span>
                <span class="n">filePathName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiledLibFolder</span><span class="p">,</span> <span class="n">tileFileMainName</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tileId</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.snz&#39;</span><span class="p">)</span> <span class="c1"># for snappy format</span>

                <span class="c1"># save to parquet file. Can only save one DataFrame!</span>
                <span class="c1"># tdf.to_parquet(filePathName,engine=&#39;fastparquet&#39;,compression=&#39;gzip&#39;,index=False) # gzip</span>
                <span class="n">tdf</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">filePathName</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;fastparquet&#39;</span><span class="p">,</span><span class="n">compression</span><span class="o">=</span><span class="s1">&#39;snappy&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># snappy fast processing</span>
                <span class="c1"># tdf.to_parquet(filePathName,engine=&#39;fastparquet&#39;,compression=&#39;snappy&#39;,index=True) # snappy fast processing</span>
            <span class="k">elif</span> <span class="n">fileFormat</span> <span class="o">==</span> <span class="s1">&#39;mat&#39;</span><span class="p">:</span>
                <span class="c1"># separate columns by datatypes (int32 and float32)</span>
                <span class="n">fspFppsArray</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="n">relColumnNames</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">dtfFilledDepthArray</span> <span class="o">=</span> <span class="n">tdf</span><span class="p">[</span><span class="n">relColumnNames</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">::]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="c1"># Save to compressed .mat file</span>
                <span class="n">dfDic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FspFpps&#39;</span><span class="p">:</span> <span class="n">fspFppsArray</span><span class="p">,</span><span class="s1">&#39;DtfFilledDepth&#39;</span><span class="p">:</span> <span class="n">dtfFilledDepthArray</span><span class="p">}</span>
                <span class="c1"># Tile cannot be too large which may cause failure in writing into .mat file. See https://github.com/scipy/scipy/issues/12465</span>
                <span class="n">filePathName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiledLibFolder</span><span class="p">,</span> <span class="n">tileFileMainName</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tileId</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">)</span>
                <span class="n">sio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">filePathName</span><span class="p">,</span> <span class="n">dfDic</span><span class="p">,</span> <span class="n">do_compression</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unsupported file format!&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># calculate the min and max DTF for each FSPs in the tile</span>
            <span class="n">fspDf</span> <span class="o">=</span> <span class="n">tdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;FspId&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">MinDtf</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dtf&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="p">),</span><span class="n">MaxDtf</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dtf&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of unique FSPs in the tile:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fspDf</span><span class="p">))</span>
            <span class="c1"># print(fspDf)</span>

            <span class="c1"># add tile ID to fsp-tile index</span>
            <span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;TileId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tileId</span>
            <span class="c1"># reorder columns</span>
            <span class="n">fspDf</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="n">fspIdxColumnNames</span><span class="p">]</span>
            <span class="c1"># append to the index table</span>
            <span class="c1"># fspIdxDf = fspIdxDf.append(fspDf,ignore_index=True)</span>
            <span class="n">fspIdxDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fspIdxDf</span><span class="p">,</span> <span class="n">fspDf</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># print(&#39;Fsp-Tile index for the tile:&#39;)</span>
            <span class="c1"># print(fspIdxDf)</span>

            <span class="c1"># Calculate FSP &amp; FPP external extents for saving in the tile-index file</span>
            <span class="n">fspMinX</span><span class="p">,</span><span class="n">fspMaxX</span><span class="p">,</span><span class="n">fspMinY</span><span class="p">,</span><span class="n">fspMaxY</span> <span class="o">=</span> <span class="n">fspMinX</span><span class="o">-</span><span class="n">hcs</span><span class="p">,</span><span class="n">fspMaxX</span><span class="o">+</span><span class="n">hcs</span><span class="p">,</span><span class="n">fspMinY</span><span class="o">-</span><span class="n">hcs</span><span class="p">,</span><span class="n">fspMaxY</span><span class="o">+</span><span class="n">hcs</span>
            <span class="n">fppMinX</span><span class="p">,</span><span class="n">fppMaxX</span><span class="p">,</span><span class="n">fppMinY</span><span class="p">,</span><span class="n">fppMaxY</span> <span class="o">=</span> <span class="n">fppMinX</span><span class="o">-</span><span class="n">hcs</span><span class="p">,</span><span class="n">fppMaxX</span><span class="o">+</span><span class="n">hcs</span><span class="p">,</span><span class="n">fppMinY</span><span class="o">-</span><span class="n">hcs</span><span class="p">,</span><span class="n">fppMaxY</span><span class="o">+</span><span class="n">hcs</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tile FSP extent (fspMinX,fspMaxX,fspMinY,fspMaxY): &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">fspMinX</span><span class="p">,</span><span class="n">fspMaxX</span><span class="p">,</span><span class="n">fspMinY</span><span class="p">,</span><span class="n">fspMaxY</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tile FPP extent (fppMinX,fppMaxX,fppMinY,fppMaxY): &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">fppMinX</span><span class="p">,</span><span class="n">fppMaxX</span><span class="p">,</span><span class="n">fppMinY</span><span class="p">,</span><span class="n">fppMaxY</span><span class="p">))</span>

            <span class="c1"># Calculate the min &amp; max DTF within the tile</span>
            <span class="n">minTileDtf</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;MinDtf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">maxTileDtf</span> <span class="o">=</span> <span class="n">fspDf</span><span class="p">[</span><span class="s1">&#39;MaxDtf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># calculate number of relations and number of FPPs in the tile</span>
            <span class="n">numOfRels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tdf</span><span class="p">)</span>
            <span class="n">numOfFpps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tdf</span><span class="p">[[</span><span class="s1">&#39;FppCol&#39;</span><span class="p">,</span><span class="s1">&#39;FppRow&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span> <span class="c1"># groupby for fast?</span>

            <span class="c1"># add tile ID and additional tile-related info to the tile index file</span>
            <span class="n">tileIdx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">tileId</span><span class="p">,</span><span class="n">tminX</span><span class="p">,</span><span class="n">tmaxX</span><span class="p">,</span><span class="n">tminY</span><span class="p">,</span><span class="n">tmaxY</span><span class="p">,</span><span class="n">fppMinX</span><span class="p">,</span><span class="n">fppMaxX</span><span class="p">,</span><span class="n">fppMinY</span><span class="p">,</span><span class="n">fppMaxY</span><span class="p">,</span><span class="n">fspMinX</span><span class="p">,</span><span class="n">fspMaxX</span><span class="p">,</span><span class="n">fspMinY</span><span class="p">,</span><span class="n">fspMaxY</span><span class="p">,</span><span class="n">minTileDtf</span><span class="p">,</span><span class="n">maxTileDtf</span><span class="p">,</span><span class="n">numOfRels</span><span class="p">,</span><span class="n">numOfFpps</span><span class="p">]],</span><span class="n">columns</span><span class="o">=</span><span class="n">tileIdxColumnNames</span><span class="p">)</span>
            <span class="c1"># append to the index table</span>
            <span class="c1"># tileIdxDf = tileIdxDf.append(tileIdx,ignore_index=True)</span>
            <span class="n">tileIdxDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tileIdxDf</span><span class="p">,</span> <span class="n">tileIdx</span><span class="p">],</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># print(&#39;Tile index for the tile:&#39;)</span>
            <span class="c1"># print(tileIdxDf)</span>

            <span class="c1"># move to the next tile</span>
            <span class="n">tileId</span> <span class="o">+=</span><span class="mi">1</span>

    <span class="c1"># Save the index as a file</span>
    <span class="c1"># print(&#39;Number of items in the fsp-tile index:&#39;, len(fspIdxDf))</span>
    <span class="c1"># print(&#39;fsp-tile Index table:\n&#39;,fspIdxDf)</span>
    <span class="c1"># save index to a csv file</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Save fsp-tile index as a CSV file ...&#39;</span><span class="p">)</span>
    <span class="n">fspIdxDf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiledLibFolder</span><span class="p">,</span> <span class="n">tileFileMainName</span><span class="o">+</span><span class="s1">&#39;_fsp_index.csv&#39;</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># print(&#39;Number of items in the tile-extent index:&#39;, len(tileIdxDf))</span>
    <span class="c1"># print(&#39;Tile index table:\n&#39;,tileIdxDf)</span>
    <span class="c1"># save index to a csv file</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Save tile index as a CSV file ...&#39;</span><span class="p">)</span>
    <span class="n">tileIdxDf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiledLibFolder</span><span class="p">,</span> <span class="n">tileFileMainName</span><span class="o">+</span><span class="s1">&#39;_tile_index.csv&#39;</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">metaData</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2024-08-18T00:51:24+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-08-18</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2024-08-16T20:54:01+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-08-16</span>
  </span>

    
    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 - 2024 Xingong Li
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.top", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.af256bd8.min.js"></script>
      
        <script src="../js/timeago.min.js"></script>
      
        <script src="../js/timeago_mkdocs_material.js"></script>
      
    
  </body>
</html>